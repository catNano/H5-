

## 事件

#### 事件侦听和删除侦听

事件：通知和侦听组合完成的，先侦听后通知，执行对应的函数

创建一个事件对象

- 事件类型必须是一个字符串
- 部分事件是系统默认事件，这些事件会由系统自动抛发

```
var evt = new Event("天王盖地虎");
document.dispatchEvent(evt);//通知，抛发
```

##### 侦听事件

**IE9以上**

```
document.addEventListener("天王盖地虎",eventHandler);
function eventHandler(e){
    console.log(e);
}
```

1. 事件的类型必须相同
2. 事件侦听的对象和抛发的对象必须相同
3. 将事件抛向侦听对象就可以
4. 先侦听，后抛发
5. 事件对象.addEventListener(事件类型，事件回调函数，是否是捕获阶段（默认false，即冒泡阶段）);
6. 事件对象  必须是EventTarget或者继承他所产生子类

```
var obj={
    n:1,
    a:function(){
        document.addEventListener("chilema",this.b);
        var evt=new Event("elema");
        evt.n=this.n;
        document.dispatchEvent(evt);
    },
    b:function(e){
      console.log(e.s);
    }
}

var obj1={
    c:function(){
        document.addEventListener("elema",this.d);
    },
    d:function(e){
      console.log(e.n);
      var s=e.n;
      s++;
      var evt=new Event("chilema");
      evt.s=s;
      document.dispatchEvent(evt);
    }
}


obj1.c();
obj.a();
```

**ie8及以下**

​	element.attachEvent(‘on开头的事件名’,事件函数名)

##### 删除侦听

**IE9以上**

removeEventListener(事件类型，事件回调函数，{once:true}(监听一次));

```
var div=document.getElementsByTagName("div")[0];
// 事件类型，事件回调函数,(是否捕获时触发)
div.addEventListener("click",clickHandler);


function clickHandler(e){
    console.log(e);
    // 删除事件侦听(事件类型,删除事件侦听的回调函数)
    // this.removeEventListener("click",clickHandler)
    this.removeEventListener("click",arguments.callee);
}
```

**ie8及以下**

detachEvent(‘on开头的事件名’,事件函数名)

##### 事件侦听和删除的兼容写法

**增加侦听**

```
function addEventListen(elem,type,callback){
    try{
        elem.addEventListener(type,callback)
    }catch(e){
        elem.attachEvent("on"+type,callback);
    }
}
```

**删除侦听**

```
function removeEventListen(elem,type,callback){
    try{
        elem.removeEventListener(type,callback)
    }catch(e){
        elem.detachEvent("on"+type,callback);
    }
}
```

##### 三种侦听的区别

- addEventListener

  缺点：不支持IE8及以下，方法名太长

  优点：支持捕获和冒泡阶段分开侦听

  ​			支持事件抛发机制

  ​			支持同一个事件做多个事件回调函数

  ​			事件使用时可以将函数与内容完全分离

- attachEvent

  缺点：IE8以上不支持，没有捕获，不支持一次点击，未来被淘汰

  优点：支持IE8以下，并且可以使一个事件调用多个回调函数

  ​			事件使用时可以将函数与内容完全分离

- onclick=fn

  缺点：不支持事件抛发，只能使用系统默认事件

  优点：全浏览器支持，不考虑兼容问题

  ​			代码便捷

  ​			不支持同一个事件做多个事件回调函数

  ​			因为代码大量使用匿名函数，容易造成回调地狱，并且在开发中，代码和代码的实际功能不能分离

  ```
  div.onclick=function(){
      console.log("a");
      div.onclick=null;//删除事件
  }
  ```

  

#### 事件原理

##### 捕获阶段

从外向里

##### 目标阶段

最后点击到的叫目标

##### 冒泡阶段

从里向外

【注】

- e.stopPropagation();	停止冒泡
- e.cancelBubble=true;    IE兼容事件，取消冒泡

```
div0.addEventListener("click",div0ClickHandler);
div1.addEventListener("click",div1ClickHandler,true);
div2.addEventListener("click",div2ClickHandler);

function div0ClickHandler(e){
	e.cancelBubble=true;//IE兼容事件，取消冒泡
    console.log("div0");
}

function div1ClickHandler(e){
    console.log("div1");
    e.stopPropagation();//停止冒泡
}

function div2ClickHandler(e){
    console.log("div2");
}
```

- e.currentTarget--->事件侦听的对象---->this
- e.target--->e.srcElement--->e.toElement  事件点击的目标对象
- 事件委托：将子元素事件委托给父元素，这样就可以减少侦听的数量

```
<ul id="menu">
    <li>北京
        <ul>
            <li>昌平
                <ul>
                    <li>回龙观</li>
                    <li>天通苑</li>
                    <li>沙河</li>
                    <li>霍营</li>
                    <li>老牛湾</li>
                </ul>
            </li>
            <li>海淀</li>
            <li>朝阳</li>
            <li>东城</li>
        </ul>
    </li>
    <li>山西</li>
    <li>陕西
        <ul>
            <li>西安</li>
            <li>咸阳
                <ul>
                    <li>三原</li>
                    <li>礼泉</li>
                    <li>乾县</li>
                    <li>淳华</li>
                    <li>旬邑</li>
                </ul>
            </li>
            <li>宝鸡</li>
            <li>安康</li>
            <li>延安</li>
        </ul>
    </li>
    <li>河北</li>
    <li>河南</li>
</ul>

init();
function init(){
    var ul=document.querySelector("#menu");
    ul.addEventListener("click",clickHandler);
}

function clickHandler(e){
    // if(e.target.nodeName!=="LI")return;
    if(e.target.constructor!==HTMLLIElement)return;
    e.target.bool=!e.target.bool;		//原理没有bool，是undefined，取反，则是true
    if(!e.target.firstElementChild)return;
    if(e.target.bool)e.target.firstElementChild.style.display="none";
    else e.target.firstElementChild.style.display="block";
}
```

#### 事件对象

1. e.type  事件类型  click
2. e.target e.srcElement   事件目标对象
3. e.currentTarget  this   事件侦听对象
4. e.cancalBubble   设置取消冒泡

```
var div=document.querySelector("div");
div.addEventListener("click",clickHandler);

function clickHandler(e){
    console.log(e);	//e则是系统传入的事件对象 
}
```

#### Event事件

change	只能针对表单触发

- input  如果input.value值发生改变，并且失去焦距触发
- input checkbox radio可触发

```
<input type="text" id="user">

var user=document.querySelector("#user");
user.addEventListener("change",changeHandler);
function changeHandler(e){
    console.log(user.value);
}
```

- select select.value是选中的值

- 如果增加多选  multiple

  select.selectedOptions  被选择多个元素   select.selectedOptions[i].textContent

  select.selectedIndex   选择下标
  
  

```
<select multiple>
    <option>北京</option>
    <option>西安</option>
    <option>武汉</option>
    <option>天津</option>
    <option>青岛</option>
</select>

var user=document.querySelector("select");
user.addEventListener("change",changeHandler);
function changeHandler(e){
	console.log(user.value);
}
```

load	error

- load 和error 用于图片的加载，Ajax通信以及JSON或者其他文件的加载等

  load是加载成功，error是加载错误事件

- 图片加载是需要事件的

- 任何内容没有放在页面中，不能调用clientWidth,offsetWidth,scrollWidth这样的数据

```
var img=new Image();//document.createElement("img");
img.addEventListener("load",loadHandler);
img.src="./img/6-.jpg";
document.body.appendChild(img);
// console.log(img.offsetWidth); //如果没有load事件，img.offsetWidth为0

function loadHandler(e){
    console.log("aaa");
    console.log(img.offsetWidth)
}
```

- load还可以用于window加载创建完成
- 使用window，侦听load事件
  1. 所有的DOM加载完成
  2. 所有的图片已经加载完成

```
window.addEventListener("load",loadHandler);

function loadHandler(e){
    console.log(e);
    var div1=document.getElementById("div1");
     console.log(div1);	
     //如果div标签放在此script之后，用load可以加载成功
}
```

reset	submit

- submit和reset只能针对form表单侦听，不能针对input
- 提交和重置时收到事件

```
<form action="http://www.163.com" method="GET">
    <input type="text" name="user">
    <input type="password" name="password">
    <input type="submit">
    <input type="reset">
</form>

var form=document.querySelector("form");
form.addEventListener("submit",submitHandler);
form.addEventListener("reset",submitHandler);

function submitHandler(e){
    // 阻止默认事件
    e.preventDefault();
    // e.returnValue=false  兼容写法
    console.log(e);
}
```

resize	针对window和textArea的事件

```
window.addEventListener("resize",resizeHandler);

function resizeHandler(e){
    console.log(document.documentElement.clientWidth)
}
```

- em  这个是当前元素相对父容器font-size的大小
- rem  相对根元素font-size的大小

应用：页面跟着窗口收缩

```
div
{
    width: 1rem;
    height: 1rem;
    background-color: red;
}
img{
    width: 5.12rem;
    height: 3.11rem;
}

<div></div>
<img src="./img/6-.jpg">

window.addEventListener("resize",resizeHandler);
function resizeHandler(e){
    document.documentElement.style.fontSize=document.documentElement.clientWidth*(100/screen.width)+"px";
}
```

select	针对input的事件

- input文本选择文字时触发

```
<input type="text">

var input=document.querySelector("input");
input.addEventListener("select",selectHandler);

function selectHandler(e){
    //console.log("aa");
    //console.log(input.selectionStart);
    //console.log(input.selectionEnd);
input.value=input.value.slice(0,input.selectionStart)+input.value.slice(input.selectionEnd);
}
```

unload	卸载 现在不用了

scroll

```
div{
    width:50px;
    height: 50px;
    overflow: scroll;
}

var div=document.querySelector("div");
div.addEventListener("scroll",scrollHandler);

function scrollHandler(e){
    console.log(div.scrollTop)
}
```

popstart

- PopStateEvent   popstate事件 历史记录被回退和前进时触发

```
document.addEventListener("click",clickHandler);
window.addEventListener("popstate",popstateHandler);
function clickHandler(e){
    history.pushState({a:1},"","#1");
}

function popstateHandler(e){
    console.log(e);
}
```

